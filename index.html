<script>
    // Твоя ссылка (проверь, чтобы она была в кавычках)
    const googleUrl = "https://script.google.com/macros/s/AKfycbygPlOK2H0gFgLJewnCYKcDtwhClnmH5tJsauH1VrUl5qwCEBgCwlq41LULy0rGKBMzkg/exec";

    // 1. ЛОВУШКА ДЛЯ ОТВЕТА (вызывается самим Google)
    window.handleResponse = function(data) {
        console.log("Данные получены:", data);
        const chat = document.getElementById('chat');
        const btn = document.getElementById('btn');
        
        try {
            let resText = Array.isArray(data) ? data[0].generated_text : (data.generated_text || "Пустой ответ");
            const lastQuery = sessionStorage.getItem('lastQuery') || "";
            
            chat.innerHTML += `<div class="ai">${resText.replace(lastQuery, "").trim()}</div>`;
        } catch (e) {
            chat.innerHTML += `<div style="color:orange">! Ошибка обработки данных: ${e.message}</div>`;
        }

        btn.disabled = false;
        btn.innerText = "ПУСК";
        chat.scrollTop = chat.scrollHeight;
        
        // Удаляем "отработавший" скрипт
        const oldScript = document.getElementById('api-call');
        if(oldScript) oldScript.remove();
    };

    async function send() {
        const inp = document.getElementById('inp');
        const chat = document.getElementById('chat');
        const btn = document.getElementById('btn');
        const val = inp.value.trim();

        if(!val) return;
        
        sessionStorage.setItem('lastQuery', val);
        chat.innerHTML += `<div>> ${val}</div>`;
        btn.disabled = true;
        btn.innerText = "СВЯЗЬ...";

        // 2. ЛОВУШКА ДЛЯ ЗАПРОСА (JSONP)
        const script = document.createElement('script');
        script.id = 'api-call';
        // Добавляем callback и метку времени, чтобы Google не присылал старый ответ
        script.src = `${googleUrl}?inputs=${encodeURIComponent(val)}&callback=handleResponse&_ts=${Date.now()}`;
        
        // Если скрипт вообще не смог загрузиться (ошибка 404 или блокировка)
        script.onerror = function() {
            chat.innerHTML += `<div style="color:red">!!! КРИТИЧЕСКАЯ ОШИБКА: Google-шлюз недоступен. Проверьте настройки Deploy (Anyone).</div>`;
            btn.disabled = false;
            btn.innerText = "ПУСК";
        };

        document.body.appendChild(script);
        
        // Таймер ожидания (если Google молчит дольше 15 секунд)
        setTimeout(() => {
            if (btn.disabled) {
                chat.innerHTML += `<div style="color:yellow">? Ожидание затянулось. Попробуйте еще раз через минуту.</div>`;
                btn.disabled = false;
                btn.innerText = "ПУСК";
            }
        }, 15000);
    }
</script>
