<script>
    // 1. Твоя ссылка, которую ты получил в Google Apps Script после "Deploy"
    const googleUrl = "https://script.google.com/macros/s/AKfycbyX8xb68npYAfoDo6aK25lSCo2r6fB_oaGQyCaVJGfrmyVBkh-ko923P02TwYPPONFyzg/exec";

    // 2. ВОТ ТВОЯ НОВАЯ ФУНКЦИЯ (ОБРАБОТЧИК ОТВЕТА)
    window.handleResponse = function(data) {
        const chat = document.getElementById('chat');
        const btn = document.getElementById('btn');
        
        console.log("Данные от ИИ:", data); // Чтобы видеть ответ в консоли (F12)

        let result = data;
        // Если Google прислал строку вместо объекта, превращаем её в объект
        if (typeof data === 'string') {
            try { 
                result = JSON.parse(data); 
            } catch(e) {
                console.error("Ошибка парсинга:", e);
            }
        }

        // Извлекаем текст сообщения
        let resText = Array.isArray(result) ? result[0].generated_text : (result.generated_text || "ИИ молчит...");
        
        // Убираем из ответа текст твоего вопроса (чтобы не дублировалось)
        const lastQuery = sessionStorage.getItem('lastQuery') || "";
        const cleanText = resText.replace(lastQuery, "").trim();

        // Добавляем ответ в чат
        chat.innerHTML += `<div class="ai-msg">${cleanText}</div>`;
        
        // Возвращаем кнопку в рабочее состояние
        btn.disabled = false;
        btn.innerText = "ПУСК";
        chat.scrollTop = chat.scrollHeight;

        // Удаляем временный скрипт запроса
        const oldScript = document.getElementById('api-temp');
        if(oldScript) oldScript.remove();
    };

    // 3. ФУНКЦИЯ ОТПРАВКИ
    function send() {
        const inp = document.getElementById('inp');
        const chat = document.getElementById('chat');
        const btn = document.getElementById('btn');
        const val = inp.value.trim();

        if(!val) return;
        
        // Сохраняем вопрос, чтобы потом его вырезать из ответа
        sessionStorage.setItem('lastQuery', val);
        
        chat.innerHTML += `<div>> ${val}</div>`;
        inp.value = "";
        btn.disabled = true;
        btn.innerText = "...";

        // Создаем динамический запрос к Google
        const script = document.createElement('script');
        script.id = 'api-temp';
        script.src = `${googleUrl}?inputs=${encodeURIComponent(val)}&callback=handleResponse&ts=${Date.now()}`;
        
        script.onerror = function() {
            chat.innerHTML += `<div style="color:red">! Ошибка шлюза. Проверь настройки в Google (Anyone).</div>`;
            btn.disabled = false;
            btn.innerText = "ПУСК";
        };

        document.body.appendChild(script);
    }

    // Слушатель для клавиши Enter
    document.getElementById('inp').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') send();
    });
</script>
